<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ðŸ“‹ Infiltrations</title>
<link rel="stylesheet" href="style.css">

<style>
.infiltration-container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
  margin-top:20px;
}

.infiltration-col{
  border:2px solid #333;
  padding:16px;
}

.infiltration-col h2{
  margin-top:0;
}

.inf-list{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.inf-item{
  border-left:6px solid #5b2d8b;
  background:#f4f0fa;
  padding:8px 12px;
  font-weight:bold;
  font-size:13px;
}

/* <!-- === AJOUT PRIORITÃ‰ (DATE INFILTRATION) === --> */
.inf-date{
  font-weight:normal;
  font-size:12px;
  color:#333;
  margin-top:4px;
}
/* <!-- === FIN AJOUT PRIORITÃ‰ === --> */
</style>
</head>

<body>

<h1>ðŸ“‹ Infiltrations</h1>
<a href="index.html" class="btn">â¬… Retour tableau de bord</a>

<div class="infiltration-container">

  <div class="infiltration-col">
    <h2>Four #1</h2>
    <div id="inf-four1" class="inf-list"></div>
  </div>

  <div class="infiltration-col">
    <h2>Four #2</h2>
    <div id="inf-four2" class="inf-list"></div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/core/engine.js"></script>

<script>
const socket = io();

/* =====================================================
   RENDER INFILTRATIONS â€” ENGINE DÃ‰CIDE
===================================================== */
socket.on("engine:viewState", state=>{
  if(!state || !state.cases) return;

  const c1 = document.getElementById("inf-four1");
  const c2 = document.getElementById("inf-four2");
  c1.innerHTML = "";
  c2.innerHTML = "";

  Object.entries(state.cases).forEach(([key, c])=>{
    if(!c.infiltre) return;

    const [four, ch, zone] = key.split("/");
    const target = four === "four1" ? c1 : c2;
    if(!target) return;

    const div = document.createElement("div");
    div.className = "inf-item";

    let label = `Chambre ${ch} â€” ${zone}`;
    let dateTxt = "";

    /* <!-- === AJOUT PRIORITÃ‰ (RECHERCHE DATE INFILTRATION) === --> */
    if (Array.isArray(c.history)) {
      const lastInf = [...c.history].reverse()
        .find(h => h.action === "infiltre");

      if (lastInf) {
        const d = new Date(lastInf.ts);
        dateTxt = d.toLocaleString("fr-CA", { hour12:false });
        if (lastInf.label) label += ` : ${lastInf.label}`;
      }
    }
    /* <!-- === FIN AJOUT PRIORITÃ‰ === --> */

    div.textContent = label;

    /* <!-- === AJOUT PRIORITÃ‰ (AFFICHAGE DATE) === --> */
    if (dateTxt) {
      const small = document.createElement("div");
      small.className = "inf-date";
      small.textContent = `ðŸ•’ ${dateTxt}`;
      div.appendChild(small);
    }
    /* <!-- === FIN AJOUT PRIORITÃ‰ === --> */

    target.appendChild(div);
  });

  if(!c1.children.length){
    c1.innerHTML = "<i>Aucune infiltration</i>";
  }
  if(!c2.children.length){
    c2.innerHTML = "<i>Aucune infiltration</i>";
  }
});
</script>

</body>
</html>

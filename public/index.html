<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Travaux Ã  effectuer</title>
<link rel="stylesheet" href="style.css">

<style>
.layout{
  display:grid;
  grid-template-columns: 0.85fr 1.5fr;
  gap:32px;
}

table{ border-collapse:collapse; width:100%; }
th,td{ border:1px solid #aaa; padding:6px; font-size:13px; }
th{ background:#e6e6e6; }

tr.prio-urgent{ background:#ffb3b3; }
tr.prio-ultra{ background:#ffd6d6; }
tr.prio-orange{ background:#ffe6c7; }
tr.prio-yellow{ background:#fff3bf; }
tr.prio-impossible{ background:#e0e0e0; }

tr.work-done{
  color:#2e7d32;
  text-decoration:line-through;
}

.admin-locked{
  opacity:0.5;
  pointer-events:none;
}

/* ================= IMPRESSION ================= */
@media print {
  body * { visibility: hidden; }

  #actifs, #actifs *,
  #termines, #termines *,
  h2 { visibility: visible; }

  #actifs, #termines {
    position:absolute;
    left:0;
    width:100%;
  }
}
</style>
</head>

<body>

<h1>Travaux Ã  effectuer</h1>

<div class="buttons">
  <a href="four1.html" class="btn">Four #1</a>
  <a href="four2.html" class="btn">Four #2</a>
  <a href="infiltration.html" class="btn">Infiltration</a>
  <a href="infiltration-history.html" class="btn">history</a>
</div>

<div style="margin:10px 0;">
  <button onclick="printTravaux()">ðŸ–¨ Imprimer travaux</button>
  <button onclick="exportHistorique()">ðŸ“„ Export historique CSV</button>
</div>

<div id="user_info" style="margin-bottom:10px;font-weight:bold;"></div>
<button id="admin_btn" style="margin-bottom:15px;">Activer mode admin</button>

<h2>Heure serveur</h2>
<div id="clock" style="font-size:22px;font-weight:bold;">--:--:--</div>

<div class="layout">

<div id="admin_section">

<h2>Cadence de production</h2>
<table>
<tr><th>Four</th><th>Cycle</th></tr>
<tr>
<td>Four #1</td>
<td>
<select id="cycle_four1">
<option value="19">19 h</option>
<option value="24">24 h</option>
</select>
</td>
</tr>
<tr>
<td>Four #2</td>
<td>
<select id="cycle_four2">
<option value="19">19 h</option>
<option value="24">24 h</option>
</select>
</td>
</tr>
</table>

<h2>Zones de production (manuel)</h2>
<table>
<thead>
<tr>
<th>Zone</th>
<th>Four</th>
<th>Chambre</th>
<th>Heure transition</th>
<th>Compte Ã  rebours</th>
</tr>
</thead>
<tbody id="zones"></tbody>
</table>

</div>

<div>

<h2>Travaux actifs</h2>
<table>
<thead>
<tr><th>Four</th><th>Chambre</th><th>Zone</th><th>Travail</th></tr>
</thead>
<tbody id="actifs"></tbody>
</table>

<h2>Travaux terminÃ©s (48h)</h2>
<table>
<thead>
<tr><th>Four</th><th>Chambre</th><th>Zone</th><th>Travail</th><th>Date</th></tr>
</thead>
<tbody id="termines"></tbody>
</table>

</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io();
let STATE = null;

let CURRENT_USER = localStorage.getItem("chantier_user") || null;
let CURRENT_ROLE = localStorage.getItem("chantier_role") || "user";

/* ================= ðŸ”’ AJOUT CRITIQUE (ANTI RE-RENDER) ================= */
let EDITING_ZONE_ID = null;
/* ===================================================== */

/* ================= USER ================= */

function initUser(){
  if(!CURRENT_USER){
    const username = prompt("Ton nom :");
    if(!username){ alert("Nom requis"); return; }
    CURRENT_USER = username;
    CURRENT_ROLE = "user";
    localStorage.setItem("chantier_user", username);
    localStorage.setItem("chantier_role", "user");
  }

  document.getElementById("user_info").textContent =
    "ConnectÃ© : " + CURRENT_USER + " (" + CURRENT_ROLE + ")";

  applyRoleUI();
}

async function activateAdmin(){
  const password = prompt("Mot de passe admin :");
  if(!password) return;

  const res = await fetch("/api/login-admin",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      username: CURRENT_USER,
      password
    })
  });

  const data = await res.json();

  if(!data.ok){ alert("Mot de passe invalide"); return; }

  CURRENT_ROLE = "admin";
  localStorage.setItem("chantier_role","admin");
  initUser();
}

function applyRoleUI(){
  const section = document.getElementById("admin_section");
  if(CURRENT_ROLE !== "admin"){
    section.classList.add("admin-locked");
  } else {
    section.classList.remove("admin-locked");
  }
}

document.getElementById("admin_btn")
  .addEventListener("click", activateAdmin);

initUser();

/* ================= SOCKET ================= */

socket.on("engine:viewState", s=>{
  STATE = s;
  if(!s) return;

  if(s.serverTime){
    document.getElementById("clock").textContent =
      new Date(s.serverTime)
      .toLocaleTimeString("fr-CA",{hour12:false});
  }

  document.getElementById("cycle_four1").value = s.cycles.four1;
  document.getElementById("cycle_four2").value = s.cycles.four2;

  renderZones();
  renderActifs();
  renderTermines();
});

/* ================= CYCLES ================= */

cycle_four1.onchange = () =>
  socket.emit("cycle:update",{ 
    four:"four1", 
    hours:+cycle_four1.value,
    user: CURRENT_USER,
    role: CURRENT_ROLE
  });

cycle_four2.onchange = () =>
  socket.emit("cycle:update",{ 
    four:"four2", 
    hours:+cycle_four2.value,
    user: CURRENT_USER,
    role: CURRENT_ROLE
  });

/* ================= ZONES ================= */

function renderZones(){
  const tb = document.getElementById("zones");

  /* ðŸ”’ NE PAS RENDER SI Ã‰DITION ACTIVE */
  if (EDITING_ZONE_ID !== null) return;

  tb.innerHTML = "";

  if(!STATE || !STATE.zonesUI) return;

  STATE.zonesUI.forEach(z=>{
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${z.id}</td>
      <td>${z.four}</td>
      <td>
        <input type="number" min="1" value="${z.chambre}">
      </td>
      <td>
        <input type="time" value="${z.heureTransition}">
      </td>
      <td>${z.compteRebours}</td>
    `;

    const inputs = tr.querySelectorAll("input");

    /* ðŸ”’ PROTECTION FOCUS / BLUR */
    inputs.forEach(inp=>{
      inp.onfocus = () => EDITING_ZONE_ID = z.id;
      inp.onblur  = () => EDITING_ZONE_ID = null;
    });

    inputs[0].onchange = ()=>socket.emit("zone:update",{
      id: z.id,
      chambre: Number(inputs[0].value),
      user: CURRENT_USER,
      role: CURRENT_ROLE
    });

    inputs[1].onchange = ()=>socket.emit("zone:update",{
      id: z.id,
      heure: inputs[1].value,
      user: CURRENT_USER,
      role: CURRENT_ROLE
    });

    tb.appendChild(tr);
  });
}

/* ================= TRAVAUX ================= */

function renderActifs(){
  const tb = document.getElementById("actifs");
  tb.innerHTML = "";

  if(!STATE || !STATE.travauxPriorises) return;

  STATE.travauxPriorises.forEach(t=>{
    const [f,c,z]=t.key.split("/");
    const tr=document.createElement("tr");
    tr.className = t.priorityClass || "";
    tr.innerHTML=`
      <td>${f.toUpperCase()}</td>
      <td>${c}</td>
      <td>${z}</td>
      <td>${t.label||"Travail"}</td>
    `;
    tb.appendChild(tr);
  });
}

function renderTermines(){
  const tb = document.getElementById("termines");
  tb.innerHTML = "";

  if(!STATE || !STATE.travauxTermines) return;

  STATE.travauxTermines.forEach(t=>{
    const [f,c,z]=t.key.split("/");
    const tr=document.createElement("tr");
    tr.className="work-done";
    tr.innerHTML=`
      <td>${f.toUpperCase()}</td>
      <td>${c}</td>
      <td>${z}</td>
      <td>${t.label||"TerminÃ©"}</td>
      <td>${new Date(t.doneTs)
        .toLocaleString("fr-CA",{hour12:false})}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ================= PRINT ================= */

function printTravaux(){
  window.print();
}

/* ================= EXPORT CSV ================= */

function exportHistorique(){
  fetch("/api/events")
  .then(r=>r.json())
  .then(data=>{
    if(!data.ok) return;

    let csv="Type;Four;Chambre;Zone;Label;Utilisateur;Date\n";

    data.events.forEach(ev=>{
      const date=new Date(ev.ts)
        .toLocaleString("fr-CA",{hour12:false});

      csv+=`${ev.type};${ev.four};${String(ev.chambre).padStart(2,"0")};${ev.zone};${ev.label||""};${ev.source||""};${date}\n`;
    });

    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);

    const a=document.createElement("a");
    a.href=url;
    a.download="historique_evenements.csv";
    a.click();

    URL.revokeObjectURL(url);
  });
}

</script>
</body>
</html>

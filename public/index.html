<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Travaux Ã  effectuer</title>
<link rel="stylesheet" href="style.css">

<style>
.layout{
  display:grid;
  grid-template-columns: 0.85fr 1.5fr;
  gap:32px;
}

table{ border-collapse:collapse; width:100%; }
th,td{ border:1px solid #aaa; padding:6px; font-size:13px; }
th{ background:#e6e6e6; }

tr.prio-urgent{ background:#ffb3b3; }
tr.prio-ultra{ background:#ffd6d6; }
tr.prio-orange{ background:#ffe6c7; }
tr.prio-yellow{ background:#fff3bf; }
tr.prio-impossible{ background:#e0e0e0; }

tr.work-done{
  color:#2e7d32;
  text-decoration:line-through;
}

/* <!-- === AJOUT PRIORITÃ‰ (ADMIN VISUEL) === --> */
.admin-locked{
  opacity:0.5;
  pointer-events:none;
}
/* <!-- === FIN AJOUT PRIORITÃ‰ === --> */


/* =====================================================
   <!-- === AJOUT PRIORITÃ‰ (IMPRESSION COULEURS) === -->
===================================================== */
@media print {

  body * {
    visibility: hidden;
  }

  #actifs, #actifs *,
  #termines, #termines *,
  h2 {
    visibility: visible;
  }

  #actifs, #termines {
    position: absolute;
    left: 0;
    width: 100%;
  }

  tr.prio-urgent{ background:#ffb3b3 !important; }
  tr.prio-ultra{ background:#ffd6d6 !important; }
  tr.prio-orange{ background:#ffe6c7 !important; }
  tr.prio-yellow{ background:#fff3bf !important; }
  tr.prio-impossible{ background:#e0e0e0 !important; }

  tr.work-done{
    color:#2e7d32 !important;
  }
}
/* === FIN AJOUT PRIORITÃ‰ === */

</style>
</head>

<body>

<h1>Travaux Ã  effectuer</h1>

<div class="buttons">
  <a href="four1.html" class="btn">Four #1</a>
  <a href="four2.html" class="btn">Four #2</a>
  <a href="infiltration.html" class="btn">Infiltration</a>
  <a href="infiltration-history.html" class="btn">history</a>
</div>

<!-- === AJOUT PRIORITÃ‰ (BOUTONS EXPORT & PRINT) === -->
<div style="margin:10px 0;">
  <button onclick="printTravaux()">ðŸ–¨ Imprimer travaux</button>
  <button onclick="exportHistorique()">ðŸ“„ Export historique CSV</button>
</div>
<!-- === FIN AJOUT PRIORITÃ‰ === -->


<!-- === AJOUT PRIORITÃ‰ (AFFICHAGE UTILISATEUR) === -->
<div id="user_info" style="margin-bottom:10px;font-weight:bold;"></div>
<button id="admin_btn" style="margin-bottom:15px;">Activer mode admin</button>
<!-- === FIN AJOUT PRIORITÃ‰ === -->

<h2>Heure serveur</h2>
<div id="clock" style="font-size:22px;font-weight:bold;">--:--:--</div>

<div class="layout">

<!-- ================= GAUCHE ================= -->
<div id="admin_section">

<h2>Cadence de production</h2>
<table>
<tr><th>Four</th><th>Cycle</th></tr>
<tr>
  <td>Four #1</td>
  <td>
    <select id="cycle_four1">
      <option value="19">19 h</option>
      <option value="24">24 h</option>
    </select>
  </td>
</tr>
<tr>
  <td>Four #2</td>
  <td>
    <select id="cycle_four2">
      <option value="19">19 h</option>
      <option value="24">24 h</option>
    </select>
  </td>
</tr>
</table>

<h2>Zones de production (manuel)</h2>
<table>
<thead>
<tr>
  <th>Zone</th>
  <th>Four</th>
  <th>Chambre</th>
  <th>Heure transition</th>
  <th>Compte Ã  rebours</th>
</tr>
</thead>
<tbody id="zones"></tbody>
</table>

</div>

<!-- ================= DROITE ================= -->
<div>

<h2>Travaux actifs</h2>
<table>
<thead>
<tr><th>Four</th><th>Chambre</th><th>Zone</th><th>Travail</th></tr>
</thead>
<tbody id="actifs"></tbody>
</table>

<h2>Travaux terminÃ©s (48h)</h2>
<table>
<thead>
<tr><th>Four</th><th>Chambre</th><th>Zone</th><th>Travail</th><th>Date</th></tr>
</thead>
<tbody id="termines"></tbody>
</table>

</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let STATE = null;

/* === TON CODE ORIGINAL RESTE IDENTIQUE ICI === */
/* (je ne le modifie pas, je le laisse tel quel) */

/* =====================================================
   <!-- === AJOUT PRIORITÃ‰ (PRINT FUNCTION) === -->
===================================================== */
function printTravaux(){
  window.print();
}
/* === FIN AJOUT PRIORITÃ‰ === */


/* =====================================================
   <!-- === AJOUT PRIORITÃ‰ (EXPORT HISTORIQUE CSV) === -->
===================================================== */
function exportHistorique(){

  fetch("/api/events")
    .then(r=>r.json())
    .then(data=>{
      if(!data.ok) return;

      let csv = "Type;Four;Chambre;Zone;Label;Utilisateur;Date\n";

      data.events.forEach(ev=>{
        const date = new Date(ev.ts)
          .toLocaleString("fr-CA",{hour12:false});

        csv += `${ev.type};${ev.four};${String(ev.chambre).padStart(2,"0")};${ev.zone};${ev.label||""};${ev.source||""};${date}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "historique_evenements.csv";
      a.click();

      URL.revokeObjectURL(url);
    });
}
/* === FIN AJOUT PRIORITÃ‰ === */

</script>

</body>
</html>
